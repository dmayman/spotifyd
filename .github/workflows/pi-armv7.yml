name: build-armv7-spotifyd
on:
  workflow_dispatch:

jobs:
  build:
    # <-- fix: jammy has armhf repos
    runs-on: ubuntu-22.04
    env:
      TARGET: armv7-unknown-linux-gnueabihf
      CARGO_TERM_COLOR: always
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Add Cargo patches for librespot dev
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml <<'EOF'
          [patch.crates-io]
          librespot               = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-core          = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-playback      = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-protocol      = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-metadata      = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-audio         = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-discovery     = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          librespot-connect       = { git = "https://github.com/librespot-org/librespot", branch = "dev" }
          EOF

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ env.TARGET }}

      - name: Enable armhf & install cross deps
        run: |
          sudo dpkg --add-architecture armhf
          sudo apt-get update
          sudo apt-get install -y \
            gcc-arm-linux-gnueabihf \
            pkg-config-arm-linux-gnueabihf \
            libasound2-dev:armhf \
            libssl-dev:armhf \
            libpulse-dev:armhf \
            libdbus-1-dev:armhf

      - name: Configure cross env
        run: |
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_LIBDIR=/usr/lib/arm-linux-gnueabihf/pkgconfig" >> $GITHUB_ENV
          echo "CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc" >> $GITHUB_ENV
          echo "CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc" >> $GITHUB_ENV
          echo "RUSTFLAGS=-C codegen-units=1 -C opt-level=z" >> $GITHUB_ENV

      - name: Cargo update (apply patches)
        run: cargo update

      - name: Build (ARMv7, ALSA + MPRIS)
        run: |
          cargo build --release \
            --target $TARGET \
            --features "pulseaudio_backend,dbus_mpris"

      - name: Show librespot sources (sanity)
        run: |
          cargo tree --target $TARGET | grep -E 'librespot( |-)' || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spotifyd-armv7
          path: target/${{ env.TARGET }}/release/spotifyd
